cloud_final_modules:
- [users-groups,always]
- [scripts-user, always]
users:
- name: ubuntu
  lock_passwd: True
  gecos: Ubuntu
  groups: [adm, audio, cdrom, dialout, dip, floppy, lxd, netdev, plugdev, sudo, video]
  sudo: ["ALL=(ALL) NOPASSWD:ALL"]
  shell: /bin/bash
  ssh-authorized-keys:
  ${ssh-authorized-keys}
write_files:
  - content: |
      KUBELET_EXTRA_ARGS='--cloud-provider=aws --node-labels=node-kind.sighup.io/${kind}="" --node-labels=node-role.kubernetes.io/${kind}=""'
    path: /etc/default/kubelet
    permissions: '0644'
  - content: |
      [Unit]
      Description=Disable EC2 source/dest check
      Requires=docker.service
      After=docker.service
      
      [Service]
      Type=oneshot
      RemainAfterExit=yes
      ExecStart=/usr/bin/docker run --net=host --rm rubenv/ec2-disable-source-dest
      
      [Install]
      WantedBy=multi-user.target
    path: /lib/systemd/system/ec2-disable-source-dest.service
    permissions: '0644'
runcmd:
- systemctl daemon-reload
- systemctl enable ec2-disable-source-dest.service
- systemctl start --no-block ec2-disable-source-dest.service
- /cloud-init-report.sh ${alertmanager_hostname} &>/dev/null &
- /auto-join-node.sh ${s3_bucket_name} ${alertmanager_hostname}
